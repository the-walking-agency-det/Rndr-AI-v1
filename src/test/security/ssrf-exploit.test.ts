
import { describe, it, expect } from 'vitest';
// Import the actual validation logic
import { validateSafeUrl } from '../../../electron/handlers/network';

// We don't need to mock ipcMain here because we are testing the pure function validateSafeUrl directly.
// The integration part (registerNetworkHandlers) relies on 'electron' module which we can't easily import in this Node test env without full mocking.
// But verifying the validation logic is the core security task.

describe('Security Fix: SSRF in net:fetch-url', () => {

    it('should BLOCK file:// URLs', () => {
        const sensitiveUrl = 'file:///etc/passwd';
        expect(() => validateSafeUrl(sensitiveUrl)).toThrow(/Protocol 'file:' is not allowed/);
    });

    it('should BLOCK ftp:// URLs', () => {
        const sensitiveUrl = 'ftp://example.com/file';
        expect(() => validateSafeUrl(sensitiveUrl)).toThrow(/Protocol 'ftp:' is not allowed/);
    });

    it('should BLOCK internal metadata service URLs', () => {
        const sensitiveUrl = 'http://169.254.169.254/latest/meta-data/';
        expect(() => validateSafeUrl(sensitiveUrl)).toThrow(/Access to Cloud Metadata services is denied/);
    });

    it('should BLOCK localhost explicitly', () => {
        expect(() => validateSafeUrl('http://localhost:3000')).toThrow(/Access to localhost is denied/);
    });

    it('should BLOCK 0.0.0.0 (localhost alias)', () => {
        expect(() => validateSafeUrl('http://0.0.0.0:8000')).toThrow(/Access to localhost is denied/);
    });

    it('should BLOCK 127.x.x.x loopback variants', () => {
        expect(() => validateSafeUrl('http://127.0.0.1:8080')).toThrow(/Access to loopback address/);
        expect(() => validateSafeUrl('http://127.0.0.5:8080')).toThrow(/Access to loopback address/);
    });

    it('should BLOCK localhost with trailing dot (FQDN bypass)', () => {
        expect(() => validateSafeUrl('http://localhost./admin')).toThrow(/Access to localhost is denied/);
    });

    it('should BLOCK private network IPs (10.x, 192.168.x, 172.16.x)', () => {
        expect(() => validateSafeUrl('http://10.0.0.5/admin')).toThrow(/Access to private network/);
        expect(() => validateSafeUrl('http://192.168.1.1/router')).toThrow(/Access to private network/);
        expect(() => validateSafeUrl('http://172.16.0.1/intranet')).toThrow(/Access to private network/);
    });

    it('should ALLOW legitimate public URLs', () => {
        expect(() => validateSafeUrl('https://example.com')).not.toThrow();
        expect(() => validateSafeUrl('http://google.com')).not.toThrow();
        expect(() => validateSafeUrl('https://api.indii.os')).not.toThrow();
    });
});
