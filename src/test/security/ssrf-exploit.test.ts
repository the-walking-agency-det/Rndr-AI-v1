
import { describe, it, expect, vi } from 'vitest';
import { validateSafeUrlAsync } from '../../../electron/handlers/network';

// Mock DNS module
vi.mock('node:dns', () => {
    return {
        default: {
            promises: {
                lookup: vi.fn(),
            },
        },
        promises: {
            lookup: vi.fn(),
        }
    };
});

import dns from 'node:dns';

describe('Security Fix: SSRF in net:fetch-url', () => {

    // Helper to mock DNS response
    const mockDns = (ip: string) => {
        // @ts-expect-error - testing mock function properties for address/family validation
        dns.promises.lookup.mockResolvedValue({ address: ip, family: 4 });
    };

    it('should BLOCK file:// URLs', async () => {
        const sensitiveUrl = 'file:///etc/passwd';
        await expect(validateSafeUrlAsync(sensitiveUrl)).rejects.toThrow(/Protocol 'file:' is not allowed/);
    });

    it('should BLOCK ftp:// URLs', async () => {
        const sensitiveUrl = 'ftp://example.com/file';
        await expect(validateSafeUrlAsync(sensitiveUrl)).rejects.toThrow(/Protocol 'ftp:' is not allowed/);
    });

    it('should BLOCK internal metadata service URLs (via DNS)', async () => {
        mockDns('169.254.169.254');
        const sensitiveUrl = 'http://metadata.google.internal/latest/meta-data/';
        await expect(validateSafeUrlAsync(sensitiveUrl)).rejects.toThrow(/Security Violation/);
    });

    it('should BLOCK localhost explicitly (via DNS)', async () => {
        mockDns('127.0.0.1');
        await expect(validateSafeUrlAsync('http://localhost:3000')).rejects.toThrow(/Security Violation/);
    });

    it('should BLOCK 0.0.0.0 (localhost alias)', async () => {
        mockDns('0.0.0.0');
        await expect(validateSafeUrlAsync('http://0.0.0.0:8000')).rejects.toThrow(/Security Violation/);
    });

    it('should BLOCK 127.x.x.x loopback variants', async () => {
        mockDns('127.0.0.5');
        await expect(validateSafeUrlAsync('http://127.0.0.5:8080')).rejects.toThrow(/Security Violation/);
    });

    it('should BLOCK localhost with trailing dot (FQDN bypass) via DNS', async () => {
        mockDns('127.0.0.1');
        await expect(validateSafeUrlAsync('http://localhost./admin')).rejects.toThrow(/Security Violation/);
    });

    it('should BLOCK private network IPs (10.x)', async () => {
        mockDns('10.0.0.5');
        await expect(validateSafeUrlAsync('http://10.0.0.5/admin')).rejects.toThrow(/Security Violation/);
    });

    it('should BLOCK private network IPs (192.168.x)', async () => {
        mockDns('192.168.1.1');
        await expect(validateSafeUrlAsync('http://192.168.1.1/router')).rejects.toThrow(/Security Violation/);
    });

    it('should BLOCK private network IPs (172.16.x)', async () => {
        mockDns('172.16.0.1');
        await expect(validateSafeUrlAsync('http://172.16.0.1/intranet')).rejects.toThrow(/Security Violation/);
    });

    it('should ALLOW legitimate public URLs', async () => {
        mockDns('8.8.8.8');
        await expect(validateSafeUrlAsync('https://example.com')).resolves.not.toThrow();
        await expect(validateSafeUrlAsync('http://google.com')).resolves.not.toThrow();
        await expect(validateSafeUrlAsync('https://api.indii.os')).resolves.not.toThrow();
    });
});
