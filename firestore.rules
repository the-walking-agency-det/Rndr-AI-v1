rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is a member of the organization
    function isOrgMember(orgId) {
      let orgPath = /databases/$(database)/documents/organizations/$(orgId);
      return isAuthenticated() && exists(orgPath) &&
        request.auth.uid in get(orgPath).data.members;
    }

    // Check if orgId in resource data matches and user is a member
    function isResourceOrgMember() {
      return isAuthenticated() && isOrgMember(resource.data.orgId);
    }

    // For creates: check orgId in incoming data
    function isRequestOrgMember() {
      return isAuthenticated() && isOrgMember(request.resource.data.orgId);
    }

    // Check if user can access the project this resource belongs to
    // Requires resource to have 'projectId' field
    function canViewProject(projectId) {
      let projectPath = /databases/$(database)/documents/projects/$(projectId);
      let project = get(projectPath);
      // Access if:
      // 1. Project exists AND
      // 2. User is member of the project's organization
      return isAuthenticated() && exists(projectPath) && isOrgMember(project.data.orgId);
    }

    // ========================================
    // LICENSING (authenticated access)
    // ========================================

    match /licenses/{licenseId} {
      // Allow read if user is authenticated (public catalog)
      allow read: if isAuthenticated();
      // Only allow write if the user owns the license (assuming userId field exists)
      // If userId doesn't exist yet, we default to deny for safety until schema is updated.
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    match /license_requests/{requestId} {
      // Allow read if user owns the request
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Allow create if user owns the new request
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // USER DOCUMENTS
    // ========================================

    // Users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if isOwner(userId);

      // Usage tracking subcollection
      match /usage/{date} {
        allow read, write: if isOwner(userId);
      }

      // Saved workflows subcollection
      match /workflows/{workflowId} {
        allow read, write: if isOwner(userId);
      }

      // Social: following subcollection
      match /following/{targetUserId} {
        allow read, write: if isOwner(userId);
      }

      // Social: followers subcollection (write by anyone who wants to follow)
      match /followers/{followerId} {
        allow read: if isOwner(userId);
        allow create, delete: if isOwner(followerId);
      }

      // User Stats subcollection
      match /stats/{statId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ========================================
    // ORGANIZATIONS
    // ========================================

    match /organizations/{orgId} {
      // Only members can read
      allow read: if isAuthenticated() && request.auth.uid in resource.data.members;

      // Anyone authenticated can create (they must include themselves as member)
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.members;

      // Only members can update
      allow update: if isAuthenticated() && request.auth.uid in resource.data.members;

      // Prevent deletion (only admins via backend should delete orgs)
      allow delete: if false;
    }

    // ========================================
    // PROJECTS (org-scoped)
    // ========================================

    match /projects/{projectId} {
      allow read: if isResourceOrgMember();
      allow create: if isRequestOrgMember();
      allow update, delete: if isResourceOrgMember();
    }

    // ========================================
    // HISTORY (org-scoped generation history)
    // ========================================

    match /history/{docId} {
        allow read: if isResourceOrgMember() || (resource.data.orgId == 'personal' && resource.data.userId == request.auth.uid);
        allow create: if isRequestOrgMember() || (request.resource.data.orgId == 'personal' && request.resource.data.userId == request.auth.uid);
        allow update, delete: if isResourceOrgMember() || (resource.data.orgId == 'personal' && resource.data.userId == request.auth.uid);
    }

    // ========================================
    // VIDEO JOBS (org-scoped)
    // ========================================

    match /videoJobs/{jobId} {
      allow read: if isResourceOrgMember();
      allow create: if isRequestOrgMember();
      allow update, delete: if isResourceOrgMember();
    }

    // ========================================
    // DDEX RELEASES (org-scoped distribution)
    // ========================================

    match /ddexReleases/{releaseId} {
      allow read: if isResourceOrgMember();
      allow create: if isRequestOrgMember();
      allow update, delete: if isResourceOrgMember();
    }

    // ========================================
    // DSR REPORTS (org-scoped royalty reports)
    // ========================================

    match /dsrReports/{reportId} {
      allow read: if isResourceOrgMember();
      allow create: if isRequestOrgMember();
      allow update, delete: if isResourceOrgMember();
    }

    // ========================================
    // ROYALTY PAYMENTS (org-scoped)
    // ========================================

    match /royaltyPayments/{paymentId} {
      allow read: if isResourceOrgMember();
      allow create: if isRequestOrgMember();
      allow update, delete: if isResourceOrgMember();
    }

    // ========================================
    // CAMPAIGNS (user-scoped)
    // ========================================

    match /campaigns/{campaignId} {
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // ========================================
    // SOCIAL POSTS (user-scoped)
    // ========================================

    match /posts/{postId} {
      // Anyone authenticated can read posts (public feed)
      allow read: if isAuthenticated();

      // Only the author can create/update/delete their posts
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // FINANCE (user-scoped)
    // ========================================

    match /revenue/{revenueId} {
      allow read, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
    }

    match /earnings_reports/{reportId} {
      allow read, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
    }

    match /expenses/{expenseId} {
      allow read, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
    }

    // ========================================
    // FILE NODES (Project Resources)
    // ========================================

    match /file_nodes/{nodeId} {
      // Allow read if user owns the node OR has access to the project
      // Note: canViewProject checks for isAuthenticated, existence, and organization membership
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        canViewProject(resource.data.projectId)
      );

      // Allow create/update/delete only if user owns the node
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ========================================
    // MERCHANDISE CATALOG (admin-managed, public read)
    // ========================================

    match /merchandise_catalog/{productId} {
      // Anyone authenticated can read the catalog
      allow read: if isAuthenticated();
      // Only admins can write (TODO: implement admin check)
      allow write: if false;
    }

    // ========================================
    // SAMPLE PLATFORMS (knowledge base, public read)
    // ========================================

    match /sample_platforms/{platformId} {
      // Anyone authenticated can read platform info
      allow read: if isAuthenticated();
      // Only admins can write
      allow write: if false;
    }

    // ========================================
    // API INVENTORY (system config, admin only)
    // ========================================

    match /api_inventory/{apiId} {
      // Authenticated users can read API status
      allow read: if isAuthenticated();
      // Only admins can write
      allow write: if false;
    }

    // ========================================
    // ONBOARDING TEMPLATES (admin-managed)
    // ========================================

    match /onboarding_templates/{templateId} {
      // Anyone authenticated can read templates
      allow read: if isAuthenticated();
      // Only admins can write
      allow write: if false;
    }

    // ========================================
    // DISTRIBUTION DEPLOYMENTS (User & Org Scoped)
    // ========================================

    match /deployments/{deploymentId} {
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isResourceOrgMember();
      allow create: if (isAuthenticated() && request.resource.data.userId == request.auth.uid) || isRequestOrgMember();
      allow update, delete: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isResourceOrgMember();
    }

    // ========================================
    // MERCHANDISE (user products)
    // ========================================

    match /merchandise/{productId} {
      allow read, update, delete: if isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
    }

    // ========================================
    // DENY ALL OTHER ACCESS
    // ========================================

    // Any paths not explicitly matched above are denied by default
  }
}
