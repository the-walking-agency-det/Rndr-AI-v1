rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ========================================
    // USER-SPECIFIC STORAGE (Private)
    // ========================================

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOrgMember(orgId) {
      return isAuthenticated() && 
        request.auth.uid in firestore.get(/databases/(default)/documents/organizations/$(orgId)).data.members;
    }

    // ========================================
    // USER-SPECIFIC STORAGE (Private)
    // ========================================

    // Users can only access their own storage
    match /users/{userId}/{allPaths=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ========================================
    // ORGANIZATION-SCOPED STORAGE
    // ========================================

    // Org members can access org storage
    match /orgs/{orgId}/{allPaths=**} {
      allow read, write: if isOrgMember(orgId);
    }

    // ========================================
    // PROJECT-SPECIFIC STORAGE
    // ========================================

    // Allow users to upload to their own folder within a project
    match /projects/{projectId}/{userId}/{allPaths=**} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId
        && firestore.exists(/databases/(default)/documents/projects/$(projectId))
        && isOrgMember(firestore.get(/databases/(default)/documents/projects/$(projectId)).data.orgId);
    }

    // ========================================
    // PUBLIC ASSETS (if needed for CDN)
    // ========================================

    // Public readable assets (e.g., thumbnails, shared media)
    match /public/{allPaths=**} {
      allow read: if true;
      allow write: if false; // SECURITY: Restrict unauthorized writes to public assets
    }

    // ========================================
    // DENY ALL OTHER ACCESS
    // ========================================

    // Any paths not explicitly matched above are denied by default
  }
}
